# Diagram Generation

## Diagram Management
```mermaid
graph LR;
  %% REQVIRE-AUTOGENERATED-DIAGRAM
  %% Graph styling
  classDef userRequirement fill:#f9d6d6,stroke:#f55f5f,stroke-width:1px;
  classDef systemRequirement fill:#fce4e4,stroke:#e68a8a,stroke-width:1px;
  classDef verification fill:#d6f9d6,stroke:#5fd75f,stroke-width:1px;
  classDef default fill:#f5f5f5,stroke:#333333,stroke-width:1px;

  626af7bb0e4f5bdf["Auto-Generated Diagram Identification"];
  class 626af7bb0e4f5bdf systemRequirement;
  click 626af7bb0e4f5bdf "DiagramGeneration.md#auto-generated-diagram-identification";
  dad7eeb932afdb92["diagrams.rs"];
  class dad7eeb932afdb92 default;
  click dad7eeb932afdb92 "../../../core/src/diagrams.rs";
  626af7bb0e4f5bdf -->|satisfiedBy| dad7eeb932afdb92;
  f22d93285fcd7664["parser.rs"];
  class f22d93285fcd7664 default;
  click f22d93285fcd7664 "../../../core/src/parser.rs";
  626af7bb0e4f5bdf -->|satisfiedBy| f22d93285fcd7664;
  ce2625feec883e55["utils.rs"];
  class ce2625feec883e55 default;
  click ce2625feec883e55 "../../../core/src/utils.rs";
  626af7bb0e4f5bdf -->|satisfiedBy| ce2625feec883e55;
  2d2cf67bb8070da8["Diagram Generation Test"];
  class 2d2cf67bb8070da8 verification;
  click 2d2cf67bb8070da8 "../../Verifications/DiagramsTests.md#diagram-generation-test";
  626af7bb0e4f5bdf -.->|verifiedBy| 2d2cf67bb8070da8;
  6a6973ecb2f20ee3["Remove Generated Diagrams Verification"];
  class 6a6973ecb2f20ee3 verification;
  click 6a6973ecb2f20ee3 "../../Verifications/DiagramsTests.md#remove-generated-diagrams-verification";
  626af7bb0e4f5bdf -.->|verifiedBy| 6a6973ecb2f20ee3;
  4538e809d640b93a["Diagram Generation"];
  class 4538e809d640b93a systemRequirement;
  click 4538e809d640b93a "DiagramGeneration.md#diagram-generation";
  4538e809d640b93a -.->|deriveReqT| 626af7bb0e4f5bdf;
  48a352f2d1383a4["Interactive Mermaid Diagram Node Behavior"];
  class 48a352f2d1383a4 systemRequirement;
  click 48a352f2d1383a4 "DiagramGeneration.md#interactive-mermaid-diagram-node-behavior";
  4538e809d640b93a -.->|deriveReqT| 48a352f2d1383a4;
  5332418612408aa0["SysML-Compatible Relationship Rendering"];
  class 5332418612408aa0 systemRequirement;
  click 5332418612408aa0 "DiagramGeneration.md#sysml-compatible-relationship-rendering";
  4538e809d640b93a -.->|deriveReqT| 5332418612408aa0;
  dae82e912381c0d8["CLI Generate Diagrams Flag"];
  class dae82e912381c0d8 systemRequirement;
  click dae82e912381c0d8 "../UserInterface/CLI.md#cli-generate-diagrams-flag";
  4538e809d640b93a -.->|deriveReqT| dae82e912381c0d8;
  dad7eeb932afdb92["diagrams.rs"];
  class dad7eeb932afdb92 default;
  click dad7eeb932afdb92 "../../../core/src/diagrams.rs";
  4538e809d640b93a -->|satisfiedBy| dad7eeb932afdb92;
  cd0997e703de4cff["Diagram Removal"];
  class cd0997e703de4cff systemRequirement;
  click cd0997e703de4cff "DiagramGeneration.md#diagram-removal";
  6ca4ccd32e3b556["CLI Remove Diagrams Flag"];
  class 6ca4ccd32e3b556 systemRequirement;
  click 6ca4ccd32e3b556 "../UserInterface/CLI.md#cli-remove-diagrams-flag";
  cd0997e703de4cff -.->|deriveReqT| 6ca4ccd32e3b556;
  dad7eeb932afdb92["diagrams.rs"];
  class dad7eeb932afdb92 default;
  click dad7eeb932afdb92 "../../../core/src/diagrams.rs";
  cd0997e703de4cff -->|satisfiedBy| dad7eeb932afdb92;
  80defdd4cbc7ee18["cli.rs"];
  class 80defdd4cbc7ee18 default;
  click 80defdd4cbc7ee18 "../../../cli/src/cli.rs";
  48a352f2d1383a4 -->|satisfiedBy| 80defdd4cbc7ee18;
  dad7eeb932afdb92["diagrams.rs"];
  class dad7eeb932afdb92 default;
  click dad7eeb932afdb92 "../../../core/src/diagrams.rs";
  48a352f2d1383a4 -->|satisfiedBy| dad7eeb932afdb92;
  c1bbfdadfce7e10a["Deterministic Output for All Generated Content"];
  class c1bbfdadfce7e10a systemRequirement;
  click c1bbfdadfce7e10a "../ValidationAndReporting/Reports.md#deterministic-output-for-all-generated-content";
  c1bbfdadfce7e10a -.->|deriveReqT| 4538e809d640b93a;
  11ca6eab6e458ae0["Forward-Only Relation Traversal"];
  class 11ca6eab6e458ae0 systemRequirement;
  click 11ca6eab6e458ae0 "../ValidationAndReporting/Reports.md#forward-only-relation-traversal";
  c1bbfdadfce7e10a -.->|deriveReqT| 11ca6eab6e458ae0;
  96873a19c51bd42f["Model Diagram Output Formats"];
  class 96873a19c51bd42f systemRequirement;
  click 96873a19c51bd42f "../ValidationAndReporting/Reports.md#model-diagram-output-formats";
  c1bbfdadfce7e10a -.->|deriveReqT| 96873a19c51bd42f;
  5491ea982d2d6370["Model Summary Report Generator"];
  class 5491ea982d2d6370 systemRequirement;
  click 5491ea982d2d6370 "../ValidationAndReporting/Reports.md#model-summary-report-generator";
  c1bbfdadfce7e10a -.->|deriveReqT| 5491ea982d2d6370;
  eedf6d6d3d2354d9["Interactive Mermaid Diagrams"];
  class eedf6d6d3d2354d9 userRequirement;
  click eedf6d6d3d2354d9 "../../UserRequirements.md#interactive-mermaid-diagrams";
  eedf6d6d3d2354d9 -.->|deriveReqT| 4538e809d640b93a;
  8b2dd3bb2c44db94["Remove Generated Diagrams"];
  class 8b2dd3bb2c44db94 userRequirement;
  click 8b2dd3bb2c44db94 "../../UserRequirements.md#remove-generated-diagrams";
  8b2dd3bb2c44db94 -.->|deriveReqT| cd0997e703de4cff;
```
### Diagram Generation

When requested, the system shall automatically generate diagrams and save them to the required locations of the model.

#### Relations
  * derivedFrom: [Interactive Mermaid Diagrams](../../UserRequirements.md#interactive-mermaid-diagrams)
  * derivedFrom: [Deterministic Output for All Generated Content](../ValidationAndReporting/Reports.md#deterministic-output-for-all-generated-content)
  * satisfiedBy: [diagrams.rs](../../../core/src/diagrams.rs)
---

### Auto-Generated Diagram Identification

The system shall embed a unique identification marker "REQVIRE-AUTOGENERATED-DIAGRAM" as a comment within all auto-generated mermaid diagrams to distinguish them from user-created diagrams for reliable filtering and removal operations.

#### Details
The marker must be:
- Embedded as a mermaid comment line using the `%% REQVIRE-AUTOGENERATED-DIAGRAM` format
- Present in every auto-generated diagram
- Used by diagram removal functionality to identify which diagrams to remove
- Not present in user-created custom diagrams

This enables the system to:
- Reliably identify auto-generated diagrams regardless of their location in documents
- Preserve user-created diagrams during removal operations
- Support mixed documents containing both auto-generated and custom diagrams

#### Relations
  * derivedFrom: [Diagram Generation](#diagram-generation)
  * satisfiedBy: [diagrams.rs](../../../core/src/diagrams.rs)
  * satisfiedBy: [utils.rs](../../../core/src/utils.rs)
  * satisfiedBy: [parser.rs](../../../core/src/parser.rs)
  * verifiedBy: [Diagram Generation Test](../../Verifications/DiagramsTests.md#diagram-generation-test)
  * verifiedBy: [Remove Generated Diagrams Verification](../../Verifications/DiagramsTests.md#remove-generated-diagrams-verification)
---

### Diagram Removal

When requested, the system shall remove all generated diagrams from the model by locating and deleting all mermaid code blocks that were automatically generated.

#### Relations
  * derivedFrom: [Remove Generated Diagrams](../../UserRequirements.md#remove-generated-diagrams)
  * satisfiedBy: [diagrams.rs](../../../core/src/diagrams.rs)
---

### Interactive Mermaid Diagram Node Behavior

The system shall implement interactive click behavior for Mermaid diagram nodes that redirects to the referenced element.

#### Details
Clickable mermaid diagrams links by default must use relative links to the git repository.

CLI flag options must be provided that can change default behavior to use stable github repository links:
  * diagrams click links are not working on Github if not using stable github repository links
  * from another side that pollutes PR diffs thus choice must be given to the user
  * Commands that generate diagrams (`generate-diagrams`, `export`, `serve`) must expose `--links-with-blobs` CLI flag for that purpose
  * The flag defaults to `false` (use relative paths)

When generating diagram node links and when `--links-with-blobs` flag is set to `true`, the system shall:
- Use stable git repository links (`{repository-url}/blob/{commit-hash}/{file-path}`) when git repository information is available
- Fallback to relative markdown links when git repository information is not available
- Use the current commit hash to ensure links remain stable even as the repository evolves
- Match the same link format used in traceability matrices and change impact reports
- Preserve interactive behavior across all generated diagrams

The `traces` command shall always use relative paths (hardcoded to `false`, no flag needed).

The `change-impact` command shall continue to use GitHub blob URLs by default (unchanged behavior).

#### Relations
  * derivedFrom: [Diagram Generation](#diagram-generation)
  * satisfiedBy: [diagrams.rs](../../../core/src/diagrams.rs)
  * satisfiedBy: [cli.rs](../../../cli/src/cli.rs)
---

## Diagram Rendering
```mermaid
graph LR;
  %% REQVIRE-AUTOGENERATED-DIAGRAM
  %% Graph styling
  classDef userRequirement fill:#f9d6d6,stroke:#f55f5f,stroke-width:1px;
  classDef systemRequirement fill:#fce4e4,stroke:#e68a8a,stroke-width:1px;
  classDef verification fill:#d6f9d6,stroke:#5fd75f,stroke-width:1px;
  classDef default fill:#f5f5f5,stroke:#333333,stroke-width:1px;

  78e3cd9cda00a39["Diagram Relation Filtering"];
  class 78e3cd9cda00a39 systemRequirement;
  click 78e3cd9cda00a39 "DiagramGeneration.md#diagram-relation-filtering";
  dad7eeb932afdb92["diagrams.rs"];
  class dad7eeb932afdb92 default;
  click dad7eeb932afdb92 "../../../core/src/diagrams.rs";
  78e3cd9cda00a39 -->|satisfiedBy| dad7eeb932afdb92;
  ba2fd3fb7c42cdb3["Diagram Relation Filtering Verification"];
  class ba2fd3fb7c42cdb3 verification;
  click ba2fd3fb7c42cdb3 "../../Verifications/DiagramsTests.md#diagram-relation-filtering-verification";
  78e3cd9cda00a39 -.->|verifiedBy| ba2fd3fb7c42cdb3;
  5332418612408aa0["SysML-Compatible Relationship Rendering"];
  class 5332418612408aa0 systemRequirement;
  click 5332418612408aa0 "DiagramGeneration.md#sysml-compatible-relationship-rendering";
  5332418612408aa0 -.->|deriveReqT| 78e3cd9cda00a39;
  dad7eeb932afdb92["diagrams.rs"];
  class dad7eeb932afdb92 default;
  click dad7eeb932afdb92 "../../../core/src/diagrams.rs";
  5332418612408aa0 -->|satisfiedBy| dad7eeb932afdb92;
  c860d0d799c1948f["Trace Relation Non-Directional Behavior"];
  class c860d0d799c1948f systemRequirement;
  click c860d0d799c1948f "DiagramGeneration.md#trace-relation-non-directional-behavior";
  96a12d4873ff83a0["Trace Relations No Cycles Verification"];
  class 96a12d4873ff83a0 verification;
  click 96a12d4873ff83a0 "../../Verifications/TraceRelationTests.md#trace-relations-no-cycles-verification";
  c860d0d799c1948f -.->|verifiedBy| 96a12d4873ff83a0;
  e37dc7f46d75d46["Invalid Relations Test"];
  class e37dc7f46d75d46 verification;
  click e37dc7f46d75d46 "../../Verifications/ValidationTests.md#invalid-relations-test";
  c860d0d799c1948f -.->|verifiedBy| e37dc7f46d75d46;
  4538e809d640b93a["Diagram Generation"];
  class 4538e809d640b93a systemRequirement;
  click 4538e809d640b93a "DiagramGeneration.md#diagram-generation";
  626af7bb0e4f5bdf["Auto-Generated Diagram Identification"];
  class 626af7bb0e4f5bdf systemRequirement;
  click 626af7bb0e4f5bdf "DiagramGeneration.md#auto-generated-diagram-identification";
  4538e809d640b93a -.->|deriveReqT| 626af7bb0e4f5bdf;
  48a352f2d1383a4["Interactive Mermaid Diagram Node Behavior"];
  class 48a352f2d1383a4 systemRequirement;
  click 48a352f2d1383a4 "DiagramGeneration.md#interactive-mermaid-diagram-node-behavior";
  4538e809d640b93a -.->|deriveReqT| 48a352f2d1383a4;
  4538e809d640b93a -.->|deriveReqT| 5332418612408aa0;
  dae82e912381c0d8["CLI Generate Diagrams Flag"];
  class dae82e912381c0d8 systemRequirement;
  click dae82e912381c0d8 "../UserInterface/CLI.md#cli-generate-diagrams-flag";
  4538e809d640b93a -.->|deriveReqT| dae82e912381c0d8;
  dad7eeb932afdb92["diagrams.rs"];
  class dad7eeb932afdb92 default;
  click dad7eeb932afdb92 "../../../core/src/diagrams.rs";
  4538e809d640b93a -->|satisfiedBy| dad7eeb932afdb92;
  551906d5c51d91d9["Relation Types and behaviors"];
  class 551906d5c51d91d9 systemRequirement;
  click 551906d5c51d91d9 "../../SpecificationsRequirements.md#relation-types-and-behaviors";
  551906d5c51d91d9 -.->|deriveReqT| 78e3cd9cda00a39;
  551906d5c51d91d9 -.->|deriveReqT| c860d0d799c1948f;
  7444737db501bf59["Relation Element Type Validator"];
  class 7444737db501bf59 systemRequirement;
  click 7444737db501bf59 "../ValidationAndReporting/Validation.md#relation-element-type-validator";
  551906d5c51d91d9 -.->|deriveReqT| 7444737db501bf59;
  9450d4313f47ef36["relation.rs"];
  class 9450d4313f47ef36 default;
  click 9450d4313f47ef36 "../../../core/src/relation.rs";
  551906d5c51d91d9 -->|satisfiedBy| 9450d4313f47ef36;
```
### SysML-Compatible Relationship Rendering

The system shall implement a relationship rendering engine that adheres to SysML notation standards, defining specific arrow styles, line types, and visual properties for each relationship type to ensure diagram consistency and standards compliance.

#### Details
The visual representation and direction of relationships in diagrams aligns with the SysML specification.
Each relationship is represented using SysML standard notation with a specified arrow direction.
derive (Forward):
- Definition: Links a parent element to child elements derived from it.
- Notation: Dashed arrow with an open arrowhead.
- Arrow Direction: Parent → Child (derived)
- Used when: Parent element wants to show its derived children

derivedFrom (Backward):
- Definition: Links a child element to the parent element it is derived from.
- Notation: Dashed arrow with an open arrowhead.
- Arrow Direction: Child → Parent (source)
- Used when: Child element references its source parent

verify (Backward):
- Definition: Links a verification artifact to the requirement it verifies.
- Notation: Dashed arrow with an open arrowhead.
- Arrow Direction: Verification → Requirement
- Used when: Test/verification references the requirement it validates

verifiedBy (Forward):
- Definition: Links a requirement to verification artifacts.
- Notation: Dashed arrow with an open arrowhead.
- Arrow Direction: Requirement → Verification
- Used when: Requirement shows how it's verified

satisfy (Backward):
- Definition: Links an implementation to the requirement it satisfies.
- Notation: Solid arrow with an open arrowhead.
- Arrow Direction: Implementation → Requirement
- Used when: Implementation references the requirement it satisfies

satisfiedBy (Forward):
- Definition: Links a requirement to elements that satisfy it.
- Notation: Solid arrow with an open arrowhead.
- Arrow Direction: Requirement → Implementation
- Used when: Requirement shows how it's implemented

trace (Neutral):
- Definition: Shows a general traceability relationship without implying hierarchy.
- Notation: Dashed arrow with an open arrowhead.
- Arrow Direction: Tracing → Traced (neutral)
- Used when: Simple traceability connection is needed

**Summary Table**
| Relation        | Stereotype     | Line style            | Arrowhead               | Arrow Direction                   | Hierarchy Direction |
|-----------------|----------------|-----------------------|-------------------------|-----------------------------------|-------------------- |
| **derive**      | «deriveReqt»   | dashed dependency     | open (hollow) arrowhead | Parent → Child (derived)          | Forward             |
| **derivedFrom** | «deriveReqt»   | dashed dependency     | open (hollow) arrowhead | Child → Parent (source)           | Backward            |
| **satisfy**     | «satisfy»      | solid dependency      | open (hollow) arrowhead | Implementation → Requirement      | Backward            |
| **satisfiedBy** | «satisfy»      | solid dependency      | open (hollow) arrowhead | Requirement → Implementation      | Forward             |
| **verify**      | «verify»       | dashed dependency     | open (hollow) arrowhead | Verification → Requirement        | Backward            |
| **verifiedBy**  | «verify»       | dashed dependency     | open (hollow) arrowhead | Requirement → Verification        | Forward             |
| **trace**       | «trace»        | dashed dependency     | open (hollow) arrowhead | Tracing → Traced (neutral)        | Forward             |

#### Relations
  * derivedFrom: [Diagram Generation](#diagram-generation)
  * satisfiedBy: [diagrams.rs](../../../core/src/diagrams.rs)
---

### Diagram Relation Filtering

The system shall implement relation filtering in diagram generation to render only forward relations while ensuring complete element hierarchy representation starting from top-level parent elements.

#### Details
When generating diagrams, the system shall apply the following relation filtering rules:

1. **Diagram Relation Filtering**: Only relations specified in the DIAGRAM_RELATIONS list shall be rendered to prevent duplicate arrows representing the same logical relationship
2. **Complete Hierarchy Inclusion**: When any element in a hierarchical chain is included in a section, all parent elements up to the root of the hierarchy shall be automatically included in the diagram
3. **List-Based Rendering**: Relations shall be rendered according to the DIAGRAM_RELATIONS list which defines which relation from each opposite pair should be shown

The filtering ensures that:
- Bidirectional relationships (e.g., `derivedFrom`/`derive`) appear as single arrows using the relation specified in DIAGRAM_RELATIONS
- Hierarchical context is preserved by including parent elements even if they belong to different sections
- Diagram readability is maintained while accurately representing the complete model structure

#### Relations
  * derivedFrom: [SysML-Compatible Relationship Rendering](#sysml-compatible-relationship-rendering)
  * derivedFrom: [Relation Types and behaviors](../../SpecificationsRequirements.md#relation-types-and-behaviors)
  * satisfiedBy: [diagrams.rs](../../../core/src/diagrams.rs)
---

### Trace Relation Non-Directional Behavior

The system shall treat trace relations as non-directional for circular dependency detection while maintaining their traceability purpose, ensuring that trace relations do not participate in cycle detection algorithms.

#### Details
The trace relation behavior shall include:

1. **Circular Dependency Exclusion**:
   - Trace relations shall not be traversed during circular dependency detection
   - The cycle detection algorithm shall skip trace relations to prevent false positive cycles
   - Trace relations exist solely for traceability and documentation purposes

2. **Non-Propagation Behavior**:
   - Changes shall not propagate through trace relations
   - Trace relations shall not be included in change impact analysis
   - Impact trees shall not traverse trace relation connections

3. **Bidirectional Traceability**:
   - Trace relations shall provide bidirectional navigational capability
   - Users can navigate from source to target and target to source
   - Both directions are semantically equivalent for traceability purposes

4. **Validation Behavior**:
   - Trace relations shall be validated for target existence
   - Trace relations shall not require type compatibility validation
   - Trace relations can connect any element type to any other element type

This ensures that trace relations serve their intended purpose of establishing lightweight traceability connections without creating artificial dependency constraints or participating in architectural validation logic.

#### Relations
  * derivedFrom: [Relation Types and behaviors](../../SpecificationsRequirements.md#relation-types-and-behaviors)
  * verifiedBy: [Invalid Relations Test](../../Verifications/ValidationTests.md#invalid-relations-test)
  * verifiedBy: [Trace Relations No Cycles Verification](../../Verifications/TraceRelationTests.md#trace-relations-no-cycles-verification)
---