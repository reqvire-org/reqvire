# Two-Pass Validation Architecture

## Overview
```mermaid
graph LR;
  %% REQVIRE-AUTOGENERATED-DIAGRAM
  %% Graph styling
  classDef requirement fill:#f9d6d6,stroke:#f55f5f,stroke-width:1px;
  classDef verification fill:#d6f9d6,stroke:#5fd75f,stroke-width:1px;
  classDef externalLink fill:#d0e0ff,stroke:#3080ff,stroke-width:1px;
  classDef default fill:#f5f5f5,stroke:#333333,stroke-width:1px;

  c3b9530980b77cba["GraphRegistry as Primary Registry"];
  class c3b9530980b77cba requirement;
  click c3b9530980b77cba "TwoPassValidation.md#graphregistry-as-primary-registry";
  b7c871ab64a7059a["graph_registry.rs"];
  class b7c871ab64a7059a default;
  click b7c871ab64a7059a "../../core/src/graph_registry.rs";
  c3b9530980b77cba -->|satisfiedBy| b7c871ab64a7059a;
  d50a859650933e55["model.rs"];
  class d50a859650933e55 default;
  click d50a859650933e55 "../../core/src/model.rs";
  c3b9530980b77cba -->|satisfiedBy| d50a859650933e55;
  184bc01c18f5506f["Requirements Files Search and Detection Test"];
  class 184bc01c18f5506f verification;
  click 184bc01c18f5506f "../Verifications/ValidationTests.md#requirements-files-search-and-detection-test";
  c3b9530980b77cba -.->|verifiedBy| 184bc01c18f5506f;
  c0cc52075c4770f2["Two-Pass Validation Strategy"];
  class c0cc52075c4770f2 requirement;
  click c0cc52075c4770f2 "TwoPassValidation.md#two-pass-validation-strategy";
  d50a859650933e55["model.rs"];
  class d50a859650933e55 default;
  click d50a859650933e55 "../../core/src/model.rs";
  c0cc52075c4770f2 -->|satisfiedBy| d50a859650933e55;
  e37dc7f46d75d46["Invalid Relations Test"];
  class e37dc7f46d75d46 verification;
  click e37dc7f46d75d46 "../Verifications/ValidationTests.md#invalid-relations-test";
  c0cc52075c4770f2 -.->|verifiedBy| e37dc7f46d75d46;
  b4f1757fc8831083["Validate Command"];
  class b4f1757fc8831083 requirement;
  click b4f1757fc8831083 "Requirements.md#validate-command";
  c0cc52075c4770f2 -.->|deriveReqT| b4f1757fc8831083;
  7de12ce482cb509["Validation Error Handling"];
  class 7de12ce482cb509 requirement;
  click 7de12ce482cb509 "TwoPassValidation.md#validation-error-handling";
  a581221890d15c0c["error.rs"];
  class a581221890d15c0c default;
  click a581221890d15c0c "../../core/src/error.rs";
  7de12ce482cb509 -->|satisfiedBy| a581221890d15c0c;
  d50a859650933e55["model.rs"];
  class d50a859650933e55 default;
  click d50a859650933e55 "../../core/src/model.rs";
  7de12ce482cb509 -->|satisfiedBy| d50a859650933e55;
  7de12ce482cb509 -.->|verifiedBy| e37dc7f46d75d46;
  5a67efb6be1c6c72["Integrated Validation"];
  class 5a67efb6be1c6c72 requirement;
  click 5a67efb6be1c6c72 "TwoPassValidation.md#integrated-validation";
  80defdd4cbc7ee18["cli.rs"];
  class 80defdd4cbc7ee18 default;
  click 80defdd4cbc7ee18 "../../cli/src/cli.rs";
  5a67efb6be1c6c72 -->|satisfiedBy| 80defdd4cbc7ee18;
  ed31b6bed1cde2f8["Provide Validation Reports"];
  class ed31b6bed1cde2f8 requirement;
  click ed31b6bed1cde2f8 "../UserRequirements.md#provide-validation-reports";
  d667d94124e3bab7["Validation Report Generator"];
  class d667d94124e3bab7 requirement;
  click d667d94124e3bab7 "Requirements.md#validation-report-generator";
  ed31b6bed1cde2f8 -.->|deriveReqT| d667d94124e3bab7;
  ed31b6bed1cde2f8 -.->|verifiedBy| e37dc7f46d75d46;
  ed31b6bed1cde2f8 -.->|deriveReqT| b4f1757fc8831083;
  ed31b6bed1cde2f8 -.->|deriveReqT| 5a67efb6be1c6c72;
  d50a859650933e55["model.rs"];
  class d50a859650933e55 default;
  click d50a859650933e55 "../../core/src/model.rs";
  d667d94124e3bab7 -->|satisfiedBy| d50a859650933e55;
  d667d94124e3bab7 -.->|deriveReqT| 7de12ce482cb509;
  4ecd49d71920c1fc["Detailed Error Handling and Logging"];
  class 4ecd49d71920c1fc requirement;
  click 4ecd49d71920c1fc "Requirements.md#detailed-error-handling-and-logging";
  a581221890d15c0c["error.rs"];
  class a581221890d15c0c default;
  click a581221890d15c0c "../../core/src/error.rs";
  4ecd49d71920c1fc -->|satisfiedBy| a581221890d15c0c;
  4ecd49d71920c1fc -.->|verifiedBy| e37dc7f46d75d46;
  4ecd49d71920c1fc -.->|deriveReqT| 7de12ce482cb509;
  c50887ce89be280a["Validate Internal Consistency"];
  class c50887ce89be280a requirement;
  click c50887ce89be280a "../UserRequirements.md#validate-internal-consistency";
  bcf308e253d2c6e7["Internal Consistency Validator"];
  class bcf308e253d2c6e7 requirement;
  click bcf308e253d2c6e7 "Requirements.md#internal-consistency-validator";
  c50887ce89be280a -.->|deriveReqT| bcf308e253d2c6e7;
  c50887ce89be280a -.->|deriveReqT| c0cc52075c4770f2;
  c50887ce89be280a -.->|verifiedBy| e37dc7f46d75d46;
  bed8d0948b3e5ccd["Requirements Processing"];
  class bed8d0948b3e5ccd requirement;
  click bed8d0948b3e5ccd "Requirements.md#requirements-processing";
  d50a859650933e55["model.rs"];
  class d50a859650933e55 default;
  click d50a859650933e55 "../../core/src/model.rs";
  bed8d0948b3e5ccd -->|satisfiedBy| d50a859650933e55;
  f22d93285fcd7664["parser.rs"];
  class f22d93285fcd7664 default;
  click f22d93285fcd7664 "../../core/src/parser.rs";
  bed8d0948b3e5ccd -->|satisfiedBy| f22d93285fcd7664;
  bed8d0948b3e5ccd -.->|deriveReqT| c3b9530980b77cba;
  a4090fe7e30eeae4["Element Content Extraction Test"];
  class a4090fe7e30eeae4 verification;
  click a4090fe7e30eeae4 "../Verifications/ChangeImpactTests.md#element-content-extraction-test";
  bed8d0948b3e5ccd -.->|verifiedBy| a4090fe7e30eeae4;
  6ca2ff1567644e78["Same-File Fragment Relations Test"];
  class 6ca2ff1567644e78 verification;
  click 6ca2ff1567644e78 "../Verifications/ValidationTests.md#same-file-fragment-relations-test";
  bed8d0948b3e5ccd -.->|verifiedBy| 6ca2ff1567644e78;
  66582f9b6bdde6c4["Structured Markdown Files Search and Detection"];
  class 66582f9b6bdde6c4 requirement;
  click 66582f9b6bdde6c4 "Requirements.md#structured-markdown-files-search-and-detection";
  bed8d0948b3e5ccd -.->|deriveReqT| 66582f9b6bdde6c4;
  bed8d0948b3e5ccd -.->|deriveReqT| c0cc52075c4770f2;
  8f22faacdb454b23["CLI Interface Structure"];
  class 8f22faacdb454b23 requirement;
  click 8f22faacdb454b23 "Requirements.md#cli-interface-structure";
  80defdd4cbc7ee18["cli.rs"];
  class 80defdd4cbc7ee18 default;
  click 80defdd4cbc7ee18 "../../cli/src/cli.rs";
  8f22faacdb454b23 -->|satisfiedBy| 80defdd4cbc7ee18;
  34c75e4a88e1f381["CLI Help Structure Verification"];
  class 34c75e4a88e1f381 verification;
  click 34c75e4a88e1f381 "../Verifications/Misc.md#cli-help-structure-verification";
  8f22faacdb454b23 -.->|verifiedBy| 34c75e4a88e1f381;
  749eaee85cfd0a43["CLI Remove Diagrams Flag"];
  class 749eaee85cfd0a43 requirement;
  click 749eaee85cfd0a43 "Requirements.md#cli-remove-diagrams-flag";
  8f22faacdb454b23 -.->|deriveReqT| 749eaee85cfd0a43;
  b50359102e04bf09["CLI Sections Summary Command"];
  class b50359102e04bf09 requirement;
  click b50359102e04bf09 "Requirements.md#cli-sections-summary-command";
  8f22faacdb454b23 -.->|deriveReqT| b50359102e04bf09;
  5deb63503bdf77c["HTML Export"];
  class 5deb63503bdf77c requirement;
  click 5deb63503bdf77c "Requirements.md#html-export";
  8f22faacdb454b23 -.->|deriveReqT| 5deb63503bdf77c;
  875f89a9f301fb90["Format Command"];
  class 875f89a9f301fb90 requirement;
  click 875f89a9f301fb90 "Requirements.md#format-command";
  8f22faacdb454b23 -.->|deriveReqT| 875f89a9f301fb90;
  4c9ae0a2fb751ce6["CLI Change Impact Report Command"];
  class 4c9ae0a2fb751ce6 requirement;
  click 4c9ae0a2fb751ce6 "Requirements.md#cli-change-impact-report-command";
  8f22faacdb454b23 -.->|deriveReqT| 4c9ae0a2fb751ce6;
  7bdf935ec6d8effe["Subdirectory Processing Option"];
  class 7bdf935ec6d8effe requirement;
  click 7bdf935ec6d8effe "Requirements.md#subdirectory-processing-option";
  8f22faacdb454b23 -.->|deriveReqT| 7bdf935ec6d8effe;
  52fe8f19c3102ecf["Serve Command"];
  class 52fe8f19c3102ecf requirement;
  click 52fe8f19c3102ecf "Requirements.md#serve-command";
  8f22faacdb454b23 -.->|deriveReqT| 52fe8f19c3102ecf;
  5a07afd22db51c40["CLI Summary Report Command"];
  class 5a07afd22db51c40 requirement;
  click 5a07afd22db51c40 "Requirements.md#cli-summary-report-command";
  8f22faacdb454b23 -.->|deriveReqT| 5a07afd22db51c40;
  7223dec8fe51900f["CLI Generate Diagrams Flag"];
  class 7223dec8fe51900f requirement;
  click 7223dec8fe51900f "Requirements.md#cli-generate-diagrams-flag";
  8f22faacdb454b23 -.->|deriveReqT| 7223dec8fe51900f;
  8f22faacdb454b23 -.->|deriveReqT| b4f1757fc8831083;
  8f22faacdb454b23 -.->|deriveReqT| 5a67efb6be1c6c72;
```
This document specifies the two-pass validation architecture that integrates validation into all commands that require the model, eliminating the need for a separate validation command.

---

### Two-Pass Validation Strategy

The system shall implement a two-pass validation strategy that separates element collection from relation validation, enabling complete error reporting while maintaining existing error behavior.

#### Details
The validation process shall be split into two distinct passes:

**Pass 1: Element Collection and Local Validation**
- Parse all markdown files
- Extract elements with metadata
- Apply automatic semantic normalization during parsing:
  - Convert non-link identifiers to proper markdown links with display text
  - Normalize absolute paths to relative paths for portable references
- Perform local validation (element uniqueness, identifier format, metadata syntax)
- Store elements in ElementRegistry
- Defer relation validation to Pass 2
- If errors are found, report them and exit the process

**Pass 2: Graph Construction and Relation Validation**
- Build GraphRegistry from ElementRegistry
- Validate all relations (target existence, type compatibility)
- Generate missing opposite relations
- Perform cross-component validation
- If errors are found, report them and exit the process

Both passes maintain the existing behavior where validation errors cause process termination with appropriate error reporting.

#### Relations
  * derivedFrom: [Validate Internal Consistency](../UserRequirements.md#validate-internal-consistency)
  * derivedFrom: [Requirements Processing](Requirements.md#requirements-processing)
  * satisfiedBy: [model.rs](../../core/src/model.rs)
---

### Integrated Validation

The system shall automatically perform validation when any command requires the parsed model, eliminating the need for a separate validate command.

#### Details
Commands shall be categorized into two groups:

**Commands requiring validated model:**
- model-summary: Needs complete element and relation data
- change-impact: Requires valid relations for impact analysis
- traces: Needs validated relationships for traceability
- generate-index: Requires complete element registry
- generate-diagrams: Needs valid relations for visualization
- remove-diagrams: Operates on validated markdown structure
- coverage-report: Requires complete verification data

**Commands operating on raw files:**
- html: Converts markdown to HTML without parsing elements
- format: Fixes markdown formatting without validation
- shell: Interactive mode with optional validation

Commands in the first group shall automatically run the two-pass validation and exit if any errors are found. Commands in the second group shall skip validation to allow operation on potentially invalid documents.

#### Relations
  * derivedFrom: [Provide Validation Reports](../UserRequirements.md#provide-validation-reports)
  * derivedFrom: [CLI Interface Structure](Requirements.md#cli-interface-structure)
  * satisfiedBy: [cli.rs](../../cli/src/cli.rs)
---

### Validation Error Handling

The system shall maintain consistent error handling across both validation passes, collecting all errors within each pass before reporting.

#### Details
Error handling shall follow these principles:

1. **Complete pass execution**: Each pass runs to completion, collecting all errors found
2. **Aggregated reporting**: All errors from a pass are reported together
3. **Early termination**: Process exits after reporting errors from either pass
4. **Existing error format**: Error messages maintain the current format and structure
5. **Exit codes**: Non-zero exit codes indicate validation failures

This ensures users see all relevant errors at once rather than fixing issues one at a time.

#### Relations
  * derivedFrom: [Detailed Error Handling and Logging](Requirements.md#detailed-error-handling-and-logging)
  * derivedFrom: [Validation Report Generator](Requirements.md#validation-report-generator)
  * satisfiedBy: [error.rs](../../core/src/error.rs)
  * satisfiedBy: [model.rs](../../core/src/model.rs)
---

### GraphRegistry as Primary Registry

The system shall enhance GraphRegistry to serve as the primary structure for relation operations and validation during Pass 2.

#### Details
The GraphRegistry shall be responsible for:

1. **Graph construction**: Building adjacency lists from ElementRegistry
2. **Relation validation**: Checking target existence and type compatibility
3. **Opposite generation**: Creating missing bidirectional relations
4. **Cycle detection**: Identifying circular dependencies
5. **Orphan detection**: Finding isolated elements
6. **Impact analysis**: Supporting change propagation queries

The GraphRegistry shall be constructed from the ElementRegistry after Pass 1 completes successfully.

#### Relations
  * derivedFrom: [Requirements Processing](Requirements.md#requirements-processing)
  * satisfiedBy: [graph_registry.rs](../../core/src/graph_registry.rs)
  * satisfiedBy: [model.rs](../../core/src/model.rs)
  * verifiedBy: [Requirements Files Search and Detection Test](../Verifications/ValidationTests.md#requirements-files-search-and-detection-test)
---