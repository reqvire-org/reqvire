# Diagram Tests

This document verifies the requirements for Reqvire's diagram generation functionality.

## Diagram Generation Tests
```mermaid
graph LR;
  %% REQVIRE-AUTOGENERATED-DIAGRAM
  %% Graph styling
  classDef requirement fill:#f9d6d6,stroke:#f55f5f,stroke-width:1px;
  classDef verification fill:#d6f9d6,stroke:#5fd75f,stroke-width:1px;
  classDef externalLink fill:#d0e0ff,stroke:#3080ff,stroke-width:1px;
  classDef default fill:#f5f5f5,stroke:#333333,stroke-width:1px;

  2d2cf67bb8070da8["Diagram Generation Test"];
  class 2d2cf67bb8070da8 verification;
  click 2d2cf67bb8070da8 "DiagramsTests.md#diagram-generation-test";
  3df49fd1a91c3db7["test.sh"];
  class 3df49fd1a91c3db7 default;
  click 3df49fd1a91c3db7 "../../tests/test-diagram-generation/test.sh";
  2d2cf67bb8070da8 -->|satisfiedBy| 3df49fd1a91c3db7;
  6a6973ecb2f20ee3["Remove Generated Diagrams Verification"];
  class 6a6973ecb2f20ee3 verification;
  click 6a6973ecb2f20ee3 "DiagramsTests.md#remove-generated-diagrams-verification";
  af81a7b6d75c2363["test.sh"];
  class af81a7b6d75c2363 default;
  click af81a7b6d75c2363 "../../tests/test-remove-diagrams/test.sh";
  6a6973ecb2f20ee3 -->|satisfiedBy| af81a7b6d75c2363;
  f8849dfe948d04fa["Automated Diagram Generation on PR Merge Verification"];
  class f8849dfe948d04fa verification;
  click f8849dfe948d04fa "DiagramsTests.md#automated-diagram-generation-on-pr-merge-verification";
  98af8a1cf9c86822["generate_diagrams.yml"];
  class 98af8a1cf9c86822 default;
  click 98af8a1cf9c86822 "../../.github/workflows/generate_diagrams.yml";
  f8849dfe948d04fa -->|satisfiedBy| 98af8a1cf9c86822;
  ba2fd3fb7c42cdb3["Diagram Relation Filtering Verification"];
  class ba2fd3fb7c42cdb3 verification;
  click ba2fd3fb7c42cdb3 "DiagramsTests.md#diagram-relation-filtering-verification";
  f6a73030d877fc0f["test.sh"];
  class f6a73030d877fc0f default;
  click f6a73030d877fc0f "../../tests/test-diagram-filtering/test.sh";
  ba2fd3fb7c42cdb3 -->|satisfiedBy| f6a73030d877fc0f;
  de8ab093f22a5cd7["Visualize Model Relationships Verification"];
  class de8ab093f22a5cd7 verification;
  click de8ab093f22a5cd7 "DiagramsTests.md#visualize-model-relationships-verification";
  3df49fd1a91c3db7["test.sh"];
  class 3df49fd1a91c3db7 default;
  click 3df49fd1a91c3db7 "../../tests/test-diagram-generation/test.sh";
  de8ab093f22a5cd7 -->|satisfiedBy| 3df49fd1a91c3db7;
  8b2dd3bb2c44db94["Remove Generated Diagrams"];
  class 8b2dd3bb2c44db94 requirement;
  click 8b2dd3bb2c44db94 "../UserRequirements.md#remove-generated-diagrams";
  8b2dd3bb2c44db94 -.->|verifiedBy| 6a6973ecb2f20ee3;
  4ec753faad5a75f7["Diagram Removal"];
  class 4ec753faad5a75f7 requirement;
  click 4ec753faad5a75f7 "../SystemRequirements/Requirements.md#diagram-removal";
  8b2dd3bb2c44db94 -.->|deriveReqT| 4ec753faad5a75f7;
  3e3df7ad427a88fa["Automated Diagram Generation on PR Merge"];
  class 3e3df7ad427a88fa requirement;
  click 3e3df7ad427a88fa "../SystemRequirements/Requirements.md#automated-diagram-generation-on-pr-merge";
  98af8a1cf9c86822["generate_diagrams.yml"];
  class 98af8a1cf9c86822 default;
  click 98af8a1cf9c86822 "../../.github/workflows/generate_diagrams.yml";
  3e3df7ad427a88fa -->|satisfiedBy| 98af8a1cf9c86822;
  3e3df7ad427a88fa -.->|verifiedBy| f8849dfe948d04fa;
  dad7eeb932afdb92["diagrams.rs"];
  class dad7eeb932afdb92 default;
  click dad7eeb932afdb92 "../../core/src/diagrams.rs";
  4ec753faad5a75f7 -->|satisfiedBy| dad7eeb932afdb92;
  4ec753faad5a75f7 -.->|verifiedBy| 6a6973ecb2f20ee3;
  749eaee85cfd0a43["CLI Remove Diagrams Flag"];
  class 749eaee85cfd0a43 requirement;
  click 749eaee85cfd0a43 "../SystemRequirements/Requirements.md#cli-remove-diagrams-flag";
  4ec753faad5a75f7 -->|refinedBy| 749eaee85cfd0a43;
  98a581084d5542fa["Automate Diagram Generation"];
  class 98a581084d5542fa requirement;
  click 98a581084d5542fa "../UserRequirements.md#automate-diagram-generation";
  98a581084d5542fa -.->|verifiedBy| 2d2cf67bb8070da8;
  98a581084d5542fa -.->|deriveReqT| 3e3df7ad427a88fa;
  98a581084d5542fa -.->|verifiedBy| de8ab093f22a5cd7;
  7f86e99e7804366a["Diagram Relation Filtering"];
  class 7f86e99e7804366a requirement;
  click 7f86e99e7804366a "../SystemRequirements/Requirements.md#diagram-relation-filtering";
  dad7eeb932afdb92["diagrams.rs"];
  class dad7eeb932afdb92 default;
  click dad7eeb932afdb92 "../../core/src/diagrams.rs";
  7f86e99e7804366a -->|satisfiedBy| dad7eeb932afdb92;
  7f86e99e7804366a -.->|verifiedBy| ba2fd3fb7c42cdb3;
  9b586a1e348ad25f["Auto-Generated Diagram Identification"];
  class 9b586a1e348ad25f requirement;
  click 9b586a1e348ad25f "../SystemRequirements/Requirements.md#auto-generated-diagram-identification";
  dad7eeb932afdb92["diagrams.rs"];
  class dad7eeb932afdb92 default;
  click dad7eeb932afdb92 "../../core/src/diagrams.rs";
  9b586a1e348ad25f -->|satisfiedBy| dad7eeb932afdb92;
  ce2625feec883e55["utils.rs"];
  class ce2625feec883e55 default;
  click ce2625feec883e55 "../../core/src/utils.rs";
  9b586a1e348ad25f -->|satisfiedBy| ce2625feec883e55;
  f22d93285fcd7664["parser.rs"];
  class f22d93285fcd7664 default;
  click f22d93285fcd7664 "../../core/src/parser.rs";
  9b586a1e348ad25f -->|satisfiedBy| f22d93285fcd7664;
  9b586a1e348ad25f -.->|verifiedBy| 2d2cf67bb8070da8;
  9b586a1e348ad25f -.->|verifiedBy| 6a6973ecb2f20ee3;
```
### Diagram Generation Test

This test verifies that the system can automatically generate and embed mermaid diagrams in requirements documents.

#### Details

##### Acceptance Criteria
- System should process requirements files and add/update embedded mermaid diagrams
- System should create diagrams that represent relationships between elements
- System should preserve any existing custom mermaid diagrams in the documents
- System should update automatically generated diagrams when requirements change
- System should properly visualize all relationship types (verifies, trace, refines, contains, derives, satisfies, etc.)
- System should render relationships with appropriate arrows and formatting
- All auto-generated diagrams must include the REQVIRE-AUTOGENERATED-DIAGRAM marker for identification
- Marker should be embedded within the mermaid diagram as a comment for reliable identification

##### Test Criteria
- Command exits with success (0) return code
- Modified files contain the expected mermaid diagrams
- Custom mermaid diagrams are preserved
- Diagram content accurately reflects the relationships defined in the requirements
- All relationship types are correctly visualized with proper arrows and labels (verifies, trace, refines, contains, derives, satisfies)
- Special relationship types like "deriveReqT" are properly rendered
- All auto-generated diagrams contain the REQVIRE-AUTOGENERATED-DIAGRAM marker
- Marker appears as a mermaid comment within the diagram block

#### Metadata
  * type: verification


#### Relations
  * verify: [Automate Diagram Generation](../UserRequirements.md#automate-diagram-generation)
  * verify: [Auto-Generated Diagram Identification](../SystemRequirements/Requirements.md#auto-generated-diagram-identification)
  * satisfiedBy: [test.sh](../../tests/test-diagram-generation/test.sh)

---

### Visualize Model Relationships Verification

This test verifies that the system provides visual representations of relationships within the MBSE model in the generated diagrams.

#### Details

##### Acceptance Criteria
- System should generate diagrams showing relationships between model elements
- Diagrams should clearly represent different relationship types
- Visual representation should aid in understanding dependencies between elements

##### Test Criteria
- Command exits with success (0) return code
- Generated diagrams contain all expected relationship types
- Relationships are visually differentiated based on their type
- Element dependencies are clearly displayed in the diagrams

#### Metadata
  * type: verification


#### Relations
  * verify: [Automate Diagram Generation](../UserRequirements.md#automate-diagram-generation)
  * satisfiedBy: [test.sh](../../tests/test-diagram-generation/test.sh)

---

### Automated Diagram Generation on PR Merge Verification

This test verifies that the system automatically generates and updates diagrams when pull requests are merged to the main branch.

#### Details

##### Acceptance Criteria
- System should have a GitHub workflow that automatically generates diagrams on PR merge
- The workflow should only be triggered when PRs are merged to the main branch
- Generated diagrams and traceability matrix SVG should be committed back to the main branch
- The commit message should clearly indicate the automated nature of the change

##### Test Criteria
- Workflow defined in the GitHub workflow configuration correctly
- Workflow triggers only on PR merge to main branch
- Workflow correctly checks out code, builds the tool, and generates diagrams
- Workflow generates a traceability matrix SVG file
- Workflow commits and pushes changes back to the main branch
- Commit message is informative and standardized

#### Metadata
  * type: demonstration-verification


#### Relations
  * verify: [Automated Diagram Generation on PR Merge](../SystemRequirements/Requirements.md#automated-diagram-generation-on-pr-merge)
  * satisfiedBy: [generate_diagrams.yml](../../.github/workflows/generate_diagrams.yml)

---

### Diagram Relation Filtering Verification

This test verifies that the system correctly filters relations in diagram generation to render only forward relations while ensuring complete element hierarchy representation.

#### Details

##### Acceptance Criteria
- System should render only relations from DIAGRAM_RELATIONS list to prevent duplicate arrows for bidirectional relationships
- System should include parent elements in diagrams even when they belong to different sections
- System should apply list-based rendering according to DIAGRAM_RELATIONS specification
- Generated diagrams should not contain both relations from opposite pairs for the same logical relationship

##### Test Criteria
- Command exits with success (0) return code
- Diagrams contain only relations specified in DIAGRAM_RELATIONS (e.g., `contain` but not `containedBy`)
- Bidirectional relationships appear as single arrows using the relation specified in DIAGRAM_RELATIONS
- Parent elements are included when child elements are in the section
- No duplicate arrows exist for the same logical relationship
- Arrow rendering follows the DIAGRAM_RELATIONS list specification

#### Metadata
  * type: verification


#### Relations
  * verify: [Diagram Relation Filtering](../SystemRequirements/Requirements.md#diagram-relation-filtering)
  * satisfiedBy: [test.sh](../../tests/test-diagram-filtering/test.sh)

---

### Remove Generated Diagrams Verification

This test verifies that the system can remove all generated mermaid diagrams while preserving custom user-created diagrams and respecting file exclusion patterns.

#### Details

##### Acceptance Criteria
- System should remove all auto-generated mermaid diagrams identified by the REQVIRE-AUTOGENERATED-DIAGRAM marker
- System should preserve custom mermaid diagrams that do not contain the auto-generation marker
- System should respect exclusion patterns defined in reqvire.yaml configuration
- System should handle files with multiple diagrams correctly, removing only marked ones
- System should work on files without any diagrams
- System should maintain file structure and content except for diagram removal
- Auto-generated diagrams must contain the REQVIRE-AUTOGENERATED-DIAGRAM marker for identification
- Marker-based identification should work regardless of diagram location in the document

##### Test Criteria
- Command exits with success (0) return code
- Auto-generated diagrams containing REQVIRE-AUTOGENERATED-DIAGRAM marker are removed from files
- Custom diagrams without the marker are preserved regardless of their location
- Files matching exclusion patterns are not processed for diagram removal
- File structure remains intact except for diagram removal
- Element text and relationships are preserved
- Section headers and element headers are preserved
- Mixed files with both auto-generated (marked) and custom (unmarked) diagrams handle removal correctly

#### Metadata
  * type: verification


#### Relations
  * verify: [Remove Generated Diagrams](../UserRequirements.md#remove-generated-diagrams)
  * verify: [Diagram Removal](../SystemRequirements/Requirements.md#diagram-removal)
  * verify: [Auto-Generated Diagram Identification](../SystemRequirements/Requirements.md#auto-generated-diagram-identification)
  * satisfiedBy: [test.sh](../../tests/test-remove-diagrams/test.sh)

---