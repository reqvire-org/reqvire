# Report Generation Tests

This document contains verification tests for Reqvire's report generation capabilities.

## Report Generation Tests
```mermaid
graph LR;
  %% REQVIRE-AUTOGENERATED-DIAGRAM
  %% Graph styling
  classDef requirement fill:#f9d6d6,stroke:#f55f5f,stroke-width:1px;
  classDef verification fill:#d6f9d6,stroke:#5fd75f,stroke-width:1px;
  classDef externalLink fill:#d0e0ff,stroke:#3080ff,stroke-width:1px;
  classDef default fill:#f5f5f5,stroke:#333333,stroke-width:1px;

  9bf743e946ad83ea["Sections Summary Tests"];
  class 9bf743e946ad83ea verification;
  click 9bf743e946ad83ea "ReportsTests.md#sections-summary-tests";
  bf32ae8da9b17852["test.sh"];
  class bf32ae8da9b17852 default;
  click bf32ae8da9b17852 "../../tests/test-sections-summary/test.sh";
  9bf743e946ad83ea -->|satisfiedBy| bf32ae8da9b17852;
  349f5e874cf22d98["Verification Coverage Report Test"];
  class 349f5e874cf22d98 verification;
  click 349f5e874cf22d98 "ReportsTests.md#verification-coverage-report-test";
  7099e5b2f8a08808["test.sh"];
  class 7099e5b2f8a08808 default;
  click 7099e5b2f8a08808 "../../tests/test-coverage-report/test.sh";
  349f5e874cf22d98 -->|satisfiedBy| 7099e5b2f8a08808;
  3108f29b131412a3["Index Generation Test"];
  class 3108f29b131412a3 verification;
  click 3108f29b131412a3 "ReportsTests.md#index-generation-test";
  1123809d5f501bf1["test.sh"];
  class 1123809d5f501bf1 default;
  click 1123809d5f501bf1 "../../tests/test-index-generation/test.sh";
  3108f29b131412a3 -->|satisfiedBy| 1123809d5f501bf1;
  76ae69270700044b["Model Summary Tests"];
  class 76ae69270700044b verification;
  click 76ae69270700044b "ReportsTests.md#model-summary-tests";
  7b75340700b95177["test.sh"];
  class 7b75340700b95177 default;
  click 7b75340700b95177 "../../tests/test-model-summary-reports/test.sh";
  76ae69270700044b -->|satisfiedBy| 7b75340700b95177;
  b50359102e04bf09["CLI Sections Summary Command"];
  class b50359102e04bf09 requirement;
  click b50359102e04bf09 "../SystemRequirements/Requirements.md#cli-sections-summary-command";
  80defdd4cbc7ee18["cli.rs"];
  class 80defdd4cbc7ee18 default;
  click 80defdd4cbc7ee18 "../../cli/src/cli.rs";
  b50359102e04bf09 -->|satisfiedBy| 80defdd4cbc7ee18;
  994f165ff784760d["sections_summary.rs"];
  class 994f165ff784760d default;
  click 994f165ff784760d "../../core/src/sections_summary.rs";
  b50359102e04bf09 -->|satisfiedBy| 994f165ff784760d;
  b50359102e04bf09 -.->|verifiedBy| 9bf743e946ad83ea;
  a3ed678951ce89ea["Sections Summary Report Generator"];
  class a3ed678951ce89ea requirement;
  click a3ed678951ce89ea "../SystemRequirements/Requirements.md#sections-summary-report-generator";
  994f165ff784760d["sections_summary.rs"];
  class 994f165ff784760d default;
  click 994f165ff784760d "../../core/src/sections_summary.rs";
  a3ed678951ce89ea -->|satisfiedBy| 994f165ff784760d;
  a3ed678951ce89ea -.->|verifiedBy| 9bf743e946ad83ea;
  a3ed678951ce89ea -.->|deriveReqT| b50359102e04bf09;
  40ff89d68c242f45["Handle Invalid Regex Filter Patterns"];
  class 40ff89d68c242f45 requirement;
  click 40ff89d68c242f45 "../SystemRequirements/Requirements.md#handle-invalid-regex-filter-patterns";
  80defdd4cbc7ee18["cli.rs"];
  class 80defdd4cbc7ee18 default;
  click 80defdd4cbc7ee18 "../../cli/src/cli.rs";
  40ff89d68c242f45 -->|satisfiedBy| 80defdd4cbc7ee18;
  40ff89d68c242f45 -.->|verifiedBy| 76ae69270700044b;
  3540af61a4cc1984["CLI Coverage Report Command"];
  class 3540af61a4cc1984 requirement;
  click 3540af61a4cc1984 "../SystemRequirements/Requirements.md#cli-coverage-report-command";
  3540af61a4cc1984 -.->|verifiedBy| 349f5e874cf22d98;
  c2b6c74b77726ad9["Generate Documentation Index"];
  class c2b6c74b77726ad9 requirement;
  click c2b6c74b77726ad9 "../UserRequirements.md#generate-documentation-index";
  c2b6c74b77726ad9 -.->|verifiedBy| 3108f29b131412a3;
  84b3d0502132adb5["Documentation Index HTML Integration"];
  class 84b3d0502132adb5 requirement;
  click 84b3d0502132adb5 "../UserRequirements.md#documentation-index-html-integration";
  c2b6c74b77726ad9 -->|refinedBy| 84b3d0502132adb5;
  a21995894299effb["Index Generation"];
  class a21995894299effb requirement;
  click a21995894299effb "../SystemRequirements/Requirements.md#index-generation";
  c2b6c74b77726ad9 -.->|deriveReqT| a21995894299effb;
  73db87f73ef4c5a2["Model Summary Fine Grained Filtering"];
  class 73db87f73ef4c5a2 requirement;
  click 73db87f73ef4c5a2 "../SystemRequirements/Requirements.md#model-summary-fine-grained-filtering";
  c4ea332ba94e8299["reports.rs"];
  class c4ea332ba94e8299 default;
  click c4ea332ba94e8299 "../../core/src/reports.rs";
  73db87f73ef4c5a2 -->|satisfiedBy| c4ea332ba94e8299;
  80defdd4cbc7ee18["cli.rs"];
  class 80defdd4cbc7ee18 default;
  click 80defdd4cbc7ee18 "../../cli/src/cli.rs";
  73db87f73ef4c5a2 -->|satisfiedBy| 80defdd4cbc7ee18;
  73db87f73ef4c5a2 -.->|verifiedBy| 76ae69270700044b;
  f7a606aa79ba438["Verification Coverage Report"];
  class f7a606aa79ba438 requirement;
  click f7a606aa79ba438 "../UserRequirements.md#verification-coverage-report";
  f7a606aa79ba438 -.->|verifiedBy| 349f5e874cf22d98;
  2f5273c3b5655b33["Verification Coverage Report Generator"];
  class 2f5273c3b5655b33 requirement;
  click 2f5273c3b5655b33 "../SystemRequirements/Requirements.md#verification-coverage-report-generator";
  f7a606aa79ba438 -.->|deriveReqT| 2f5273c3b5655b33;
  5a07afd22db51c40["CLI Summary Report Command"];
  class 5a07afd22db51c40 requirement;
  click 5a07afd22db51c40 "../SystemRequirements/Requirements.md#cli-summary-report-command";
  80defdd4cbc7ee18["cli.rs"];
  class 80defdd4cbc7ee18 default;
  click 80defdd4cbc7ee18 "../../cli/src/cli.rs";
  5a07afd22db51c40 -->|satisfiedBy| 80defdd4cbc7ee18;
  5a07afd22db51c40 -.->|deriveReqT| a3ed678951ce89ea;
  5a07afd22db51c40 --o|contains| 40ff89d68c242f45;
  5a07afd22db51c40 -.->|deriveReqT| 3540af61a4cc1984;
  5a07afd22db51c40 -.->|verifiedBy| 76ae69270700044b;
  8cafc3875f5e4938["Display Name-Regex Option in Help"];
  class 8cafc3875f5e4938 requirement;
  click 8cafc3875f5e4938 "../SystemRequirements/Requirements.md#display-name-regex-option-in-help";
  5a07afd22db51c40 -.->|deriveReqT| 8cafc3875f5e4938;
  ad6f7a2d41d80a38["Model Structure and Summaries"];
  class ad6f7a2d41d80a38 requirement;
  click ad6f7a2d41d80a38 "../UserRequirements.md#model-structure-and-summaries";
  ad6f7a2d41d80a38 -.->|verifiedBy| 76ae69270700044b;
  b882613af131f35f["Model Summary Report Generator"];
  class b882613af131f35f requirement;
  click b882613af131f35f "../SystemRequirements/Requirements.md#model-summary-report-generator";
  ad6f7a2d41d80a38 -.->|deriveReqT| b882613af131f35f;
  80defdd4cbc7ee18["cli.rs"];
  class 80defdd4cbc7ee18 default;
  click 80defdd4cbc7ee18 "../../cli/src/cli.rs";
  8cafc3875f5e4938 -->|satisfiedBy| 80defdd4cbc7ee18;
  8cafc3875f5e4938 -.->|verifiedBy| 76ae69270700044b;
  2f5273c3b5655b33 -.->|verifiedBy| 349f5e874cf22d98;
  2f5273c3b5655b33 -.->|deriveReqT| 3540af61a4cc1984;
  1a173441705701a0["index_generator.rs"];
  class 1a173441705701a0 default;
  click 1a173441705701a0 "../../core/src/index_generator.rs";
  a21995894299effb -->|satisfiedBy| 1a173441705701a0;
  80defdd4cbc7ee18["cli.rs"];
  class 80defdd4cbc7ee18 default;
  click 80defdd4cbc7ee18 "../../cli/src/cli.rs";
  a21995894299effb -->|satisfiedBy| 80defdd4cbc7ee18;
  a21995894299effb -.->|verifiedBy| 3108f29b131412a3;
```
### Index Generation Test

This test verifies that the system correctly generates an index document with links and summaries to all specification documents.

#### Details

##### Acceptance Criteria
- System shall generate README.md in the specifications folder
- README.md shall contain links to all specification documents
- README.md shall be properly structured with sections
- README.md shall include brief summaries of each document

##### Test Criteria
- Command with --generate-index flag runs successfully
- README.md file is created in the specifications folder
- README.md contains links to all specification documents
- README.md structure follows expected format

#### Metadata
  * type: test-verification


#### Relations
  * verify: [Index Generation](../SystemRequirements/Requirements.md#index-generation)
  * satisfiedBy: [test.sh](../../tests/test-index-generation/test.sh)

---

### Model Summary Tests

This test verifies that the system provides a CLI flag and functionality for generating summary reports of model structure and relationships including varius filters.

#### Details

##### Acceptance Criteria
- Running `reqvire --model-summary --json` produces a valid, pretty-printed JSON summary.
- Running `reqvire --model-summary` (no `--json`) prints a human-readable markdown text summary beginning with `--- MBSE Model summary ---`.
- Both JSON and text summaries include exactly five elements with the identifiers:
  - `Requirement-with-Valid-Standard-Relations`
  - `Requirement-with-Valid-Markdown-Relations`
  - `Requirement-with-DesignSpecifications-Reference`
  - `Requirement-with-Many-Subsections`
  - `Verification-of-Standard-Relations`
- When any filter flags (`--filter-file`, `--filter-section`, `--filter-type`, `--filter-name-regex`, `--filter-content`, `--filter-is-verified`, `--filter-is-satisfied`) are supplied with `--model-summary` (and optionally `--json`), only elements matching **all** specified filters appear in both outputs.
- Supplying multiple filters in combination yields the intersection of their individual results.
- Running any filter flag **without** `--model-summary` fails with a non-zero exit code and a help message indicating the dependency.
- Supplying an invalid regex to `--filter-name-regex` or `--filter-content` fails with a non-zero exit code and displays a `ReqvireError::InvalidRegex` message.
- Model summary report must include all relations for each element, showing both explicit relations and their opposite relations (e.g., if a requirement has `verifiedBy`, the verification element should show `verify`; if a verification has `verify`, the requirement should show `verifiedBy`).
- **Enhanced Content Display**: Model summary must display page content (frontmatter before first section) and section content (content between section headers and first element).
- **Count Information**: Model summary must show counts for files, pages, sections, and elements in both text and JSON formats.
- **Content Formatting**: Page content and section content must use consistent newline formatting (`\n`) matching element content display format.
- **Global Statistics**: Summary must include comprehensive global counters including total files, sections, elements, and verification/satisfaction statistics.

##### Test Criteria

1. **Base JSON summary**  
   Command: `reqvire --model-summary --json`  
   - exits code **0**  
   - output parses under `jq`  
   - `.model_summary.global_counters.total_elements == 5`  
   - `.model_summary.files` contains key `"Requirements.md"`  
   - `.model_summary.files["Requirements.md"]["Requirements"]` contains exactly the five identifiers above  

2. **Base text summary**  
   Command: `reqvire --model-summary`  
   - exits code **0**  
   - first line is `--- MBSE Model summary ---`  
   - exactly five lines matching `🔹 Element: <identifier>` for the five identifiers above  
   - each element block includes `- Name:`, `- Section:`, `- File:`, `- Type:`, and `- Content:`  

3. **Individual filters**  
   For each flag in turn, run both JSON and text modes:  
   - `--filter-file="Requirements.md"`  
   - `--filter-section="Requirements"`  
   - `--filter-type="user-requirement"`  
   - `--filter-name-regex="^Requirement with Valid Standard"`  
   - `--filter-content="subsection"`  
   - `--filter-is-verified`  
   - `--filter-is-satisfied`  
   Assert for each:  
   - exit code **0**  
   - total elements < 5 (unless the filter matches all)  
   - only the expected subset of identifiers appears  

4. **Filter combinations**  
   Combine two filters (e.g. `--filter-type=user-requirement` + `--filter-is-satisfied`) and verify both outputs contain exactly those identifiers passing both filters.

5. **Invalid regex**  
   Command: `reqvire --model-summary --json --filter-name-regex="***"`  
   - exits non-zero  
   - stderr contains `Invalid regex`  

6. **Filter without model-summary**
   Command: `reqvire --filter-file="*.md"`
   - exits non-zero
   - stderr indicates `requires --model-summary`

7. **Relations coverage**
   Command: `reqvire --model-summary --json`
   - For any requirement with `verifiedBy` relations, verify that the target verification elements show corresponding `verify` relations pointing back to the requirement
   - For any verification with `verify` relations, verify that the target requirement elements show corresponding `verifiedBy` relations pointing back to the verification
   - Same pattern applies to other relation pairs: `satisfiedBy`/`satisfy`, `containedBy`/`contain`, `derivedFrom`/`derive`, `refine`/`refinedBy`
   - Both JSON and text outputs must show complete bidirectional relationship information

8. **Enhanced content and counts verification**
   Command: `reqvire --model-summary --json`
   - JSON output must include `page_content` field for files that have frontmatter content
   - JSON output must include `section_content` field for sections that have content
   - JSON output must include count fields: `total_files`, `total_sections`, `total_elements` in global counters
   - JSON output must include per-file counts: `total_sections`, `total_elements` in file summaries
   - JSON output must include per-section counts: `element_count` in section summaries

9. **Enhanced text output verification**
   Command: `reqvire --model-summary`
   - Text output must show file counts in format: `📂 File: path (sections: N, elements: N)`
   - Text output must show section counts in format: `📖 Section: name (elements: N)`
   - Text output must display page content with `📄 Page content: "content with \n"` format when present
   - Text output must display section content with `📝 Section content: "content with \n"` format when present
   - Global summary must include counts for total files, sections, and elements

#### Metadata
  * type: test-verification


#### Relations
  * verify: [Model Structure and Summaries](../UserRequirements.md#model-structure-and-summaries)
  * verify: [CLI Summary Report Command](../SystemRequirements/Requirements.md#cli-summary-report-command)
  * satisfiedBy: [test.sh](../../tests/test-model-summary-reports/test.sh)

---

### Verification Coverage Report Test

This test verifies that the system correctly generates verification coverage reports focusing on leaf requirements and showing the percentage and details of satisfied and unsatisfied test-verification elements.

#### Details

##### Acceptance Criteria
- System shall provide a CLI command `coverage-report` that generates coverage reports focusing on leaf requirements
- Command shall support `--json` flag for JSON output format
- Coverage report shall include summary section with total counts and percentages for leaf requirements
- Coverage report shall show breakdown by verification type (test, analysis, inspection, demonstration)
- Coverage report shall list verified leaf requirements grouped by file and section
- Coverage report shall list unverified leaf requirements with details
- Coverage report shall list satisfied test-verification elements (those with satisfiedBy relations)
- Coverage report shall list unsatisfied test-verification elements (those without satisfiedBy relations)
- Non-test-verification elements (analysis, inspection, demonstration) are considered satisfied by default (no satisfiedBy required)
- JSON output shall be valid and machine-readable
- Text output shall be human-readable with clear formatting

##### Test Criteria

1. **Basic Coverage Report**
   Command: `reqvire coverage-report`
   - exits code **0**
   - output contains `=== Verification Coverage Report ===`
   - output contains `Summary:` section with leaf requirements counts and percentages
   - output contains `Verification Types:` breakdown
   - output contains coverage percentage calculation for leaf requirements
   - verified leaf requirements are marked with ✅
   - unverified leaf requirements are marked with ❌
   - satisfied test-verification elements are marked with ✅
   - unsatisfied test-verification elements are marked with ❌

2. **JSON Coverage Report**
   Command: `reqvire coverage-report --json`
   - exits code **0**
   - output parses as valid JSON
   - JSON contains `summary` object with leaf requirements counts and percentages
   - JSON contains `verified_leaf_requirements` and `unverified_leaf_requirements` sections
   - JSON contains `satisfied_test_verifications` and `unsatisfied_test_verifications` sections
   - verification details include identifier, name, section, type, and satisfied_by relations (for test-verification only)

3. **Coverage Calculation**
   - Leaf requirements coverage percentage calculated as (verified_leaf_requirements/total_leaf_requirements * 100)
   - Test-verification satisfaction percentage calculated as (satisfied_test_verifications/total_test_verifications * 100)
   - Verification types correctly categorized
   - Test-verification elements without satisfiedBy relations are flagged as unsatisfied
   - Test-verification elements with valid satisfiedBy relations are considered satisfied
   - Analysis, inspection, and demonstration verifications are considered satisfied by default (no satisfiedBy evaluation)

#### Metadata
  * type: test-verification


#### Relations
  * satisfiedBy: [test.sh](../../tests/test-coverage-report/test.sh)

---

### Sections Summary Tests

This test verifies that the system provides sections-summary command functionality for generating focused reports of file and section structure without individual elements.

#### Details

##### Acceptance Criteria
- Running `reqvire sections-summary --json` produces a valid, pretty-printed JSON summary with sections information.
- Running `reqvire sections-summary` (no `--json`) prints a human-readable text summary showing files and sections.
- Both JSON and text outputs include file paths, section names, section order indices, and section content.
- Section order indices preserve the original document structure and enable reconstruction.
- Individual elements (requirements, verifications) are excluded from the output.
- When filter flags are supplied, only sections matching **all** specified filters appear in both outputs.
- Command supports filtering by file path (glob), section name (glob), and section content (regex).
- JSON output includes section order information for document structure reconstruction.

##### Test Criteria

1. **Base JSON sections summary**
   Command: `reqvire sections-summary --json`
   - exits code **0**
   - output parses under `jq`
   - `.files` contains file path keys
   - Each file contains sections with `name`, `content`, and `section_order` fields
   - No individual elements are included in the output

2. **Base text sections summary**
   Command: `reqvire sections-summary`
   - exits code **0**
   - output shows file paths and section information
   - sections are ordered by their `section_order` index
   - section content is displayed but individual elements are not

3. **Section filtering**
   For each filter flag, run both JSON and text modes:
   - `--filter-file="Requirements.md"` (glob pattern)
   - `--filter-section="Requirements*"` (glob pattern)
   - `--filter-content="system"` (regex pattern)
   - Each filter produces subset of sections matching criteria
   - Filters work independently and in combination

4. **Section order preservation**
   - JSON output includes `section_order` field for each section
   - Text output displays sections in document order
   - Order indices enable reconstruction of original document structure

#### Metadata
  * type: test-verification

#### Relations
  * verify: [CLI Sections Summary Command](../SystemRequirements/Requirements.md#cli-sections-summary-command)
  * verify: [Sections Summary Report Generator](../SystemRequirements/Requirements.md#sections-summary-report-generator)
  * satisfiedBy: [test.sh](../../tests/test-sections-summary/test.sh)

---