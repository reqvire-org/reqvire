<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    {styles}
    <!-- Override styles for model page to allow full diagram size -->
    <style>
    .mermaid {
        margin: 20px 0;
        text-align: center;
        width: 100%;
        overflow: auto;
        position: relative;
        border: 1px solid #dfe2e5;
        border-radius: 3px;
        background-color: #fafafa;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        min-height: calc(100vh - 150px);
    }
    .mermaid svg {
        width: auto !important;
        height: auto !important;
        max-width: none;
        max-height: none;
        position: relative;
        z-index: 1;
    }
    </style>
    <!-- Enhanced mermaid configuration for Reqvire diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.5.0/dist/svg-pan-zoom.min.js"></script>
    <script>
        // Capture Mermaid errors
        mermaid.parseError = function(err, hash) {
            console.error('Mermaid Parse Error:', err);
            console.error('Error details:', {
                str: err.str,
                hash: err.hash,
                message: err.message,
                stack: err.stack
            });
        };

        mermaid.initialize({
            startOnLoad: true,
            theme: 'neutral',
            maxTextSize: 120000,
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis'
            },
            securityLevel: 'loose',
            logLevel: 'error'
        });

        // Add pan/zoom to all Mermaid diagrams after rendering
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.querySelectorAll('.mermaid').forEach(function(mermaidContainer) {
                    var svg = mermaidContainer.querySelector('svg');
                    if (!svg) return;

                    svg.style.maxWidth = 'none';
                    svg.style.maxHeight = 'none';

                    var eventsHandler = {
                        haltEventListeners: ['touchstart', 'touchend', 'touchmove', 'touchleave', 'touchcancel'],
                        init: function(options) {
                            var instance = options.instance;
                            var initialScale = 1;
                            var pannedX = 0;
                            var pannedY = 0;

                            this.hammer = Hammer(options.svgElement, {
                                inputClass: Hammer.SUPPORT_POINTER_EVENTS ? Hammer.PointerEventInput : Hammer.TouchInput
                            });

                            this.hammer.get('pinch').set({enable: true});

                            this.hammer.on('doubletap', function(ev){
                                instance.zoomIn();
                            });

                            this.hammer.on('panstart panmove', function(ev){
                                if (ev.type === 'panstart') {
                                    pannedX = 0;
                                    pannedY = 0;
                                }
                                instance.panBy({x: ev.deltaX - pannedX, y: ev.deltaY - pannedY});
                                pannedX = ev.deltaX;
                                pannedY = ev.deltaY;
                            });

                            this.hammer.on('pinchstart pinchmove', function(ev){
                                if (ev.type === 'pinchstart') {
                                    initialScale = instance.getZoom();
                                }
                                instance.zoomAtPoint(initialScale * ev.scale, {x: ev.center.x, y: ev.center.y});
                            });

                            options.svgElement.addEventListener('touchmove', function(e){ e.preventDefault(); });
                        },
                        destroy: function(){
                            this.hammer.destroy();
                        }
                    };

                    var panZoomInstance = svgPanZoom(svg, {
                        zoomEnabled: true,
                        controlIconsEnabled: true,
                        fit: false,
                        center: true,
                        contain: false,
                        minZoom: 0.1,
                        maxZoom: 10,
                        zoomScaleSensitivity: 0.3,
                        customEventsHandler: eventsHandler
                    });

                    // Position at top-center
                    setTimeout(function() {
                        var pan = panZoomInstance.getPan();
                        panZoomInstance.pan({x: pan.x, y: 0});
                    }, 100);

                    // Add navigation buttons
                    var navButtons = document.createElement('div');
                    navButtons.className = 'diagram-nav-buttons';
                    navButtons.innerHTML = `
                        <div class="diagram-nav-row">
                            <button class="diagram-nav-btn" data-action="up">▲</button>
                        </div>
                        <div class="diagram-nav-row">
                            <button class="diagram-nav-btn" data-action="left">◀</button>
                            <button class="diagram-nav-btn" data-action="down">▼</button>
                            <button class="diagram-nav-btn" data-action="right">▶</button>
                        </div>
                    `;
                    mermaidContainer.appendChild(navButtons);

                    // Wire up navigation buttons
                    var panStep = 100;
                    navButtons.querySelectorAll('.diagram-nav-btn').forEach(function(btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            var action = this.getAttribute('data-action');
                            switch(action) {
                                case 'up':
                                    panZoomInstance.panBy({x: 0, y: panStep});
                                    break;
                                case 'down':
                                    panZoomInstance.panBy({x: 0, y: -panStep});
                                    break;
                                case 'left':
                                    panZoomInstance.panBy({x: panStep, y: 0});
                                    break;
                                case 'right':
                                    panZoomInstance.panBy({x: -panStep, y: 0});
                                    break;
                            }
                        });
                    });
                });
            }, 1500);
        });
    </script>
</head>
<body>
    <nav class="reqvire-nav">
        <a href="{nav_prefix}index.html">Index</a>
        <a href="{nav_prefix}model.html">Model</a>
        <a href="{nav_prefix}traces.html">Traces</a>
        <a href="{nav_prefix}coverage.html">Coverage</a>
        <a href="{nav_prefix}matrix.html">Matrix</a>
    </nav>
    <div class="reqvire-nav-spacer"></div>
    <div class="container">
        <div class="content">
            {content}
        </div>
    </div>
</body>
</html>
